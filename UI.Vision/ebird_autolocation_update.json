{
  "Name": "eBird AutoLocation Update",
  "CreationDate": "2025-5-15",
  "Commands": [
    {
      "Command": "store",
      "Target": "mac",
      "Value": "platform",
      "Description": ""
    },
    {
      "Command": "echo",
      "Target": "üõ†Ô∏è  Set platform to 'mac' or 'win' at the top of the macro!",
      "Value": "blue",
      "Description": ""
    },
    {
      "Command": "if_v2",
      "Target": "${platform} == 'mac'",
      "Value": "",
      "Description": ""
    },
    {
      "Command": "store",
      "Target": "/usr/bin/python3",
      "Value": "pythonPath",
      "Description": ""
    },
    {
      "Command": "store",
      "Target": "\"/Users/jameschurches/Library/Application Support/eBirdChecklistNameFromGPS/eBirdChecklistNameFromGPS.py\"",
      "Value": "scriptPath",
      "Description": ""
    },
    {
      "Command": "else",
      "Target": "",
      "Value": "",
      "Description": ""
    },
    {
      "Command": "store",
      "Target": "C:\\Python39\\python.exe",
      "Value": "pythonPath",
      "Description": ""
    },
    {
      "Command": "store",
      "Target": "\"C:\\Users\\James\\Documents\\eBirdChecklistNameFromGPS\\eBirdChecklistNameFromGPS.py\"",
      "Value": "scriptPath",
      "Description": ""
    },
    {
      "Command": "end",
      "Target": "",
      "Value": "",
      "Description": ""
    },
    {
      "Command": "echo",
      "Target": "üõ†Ô∏è Platform: ${platform}",
      "Value": "blue",
      "Description": ""
    },
    {
      "Command": "echo",
      "Target": "üêç Python Path: ${pythonPath}",
      "Value": "blue",
      "Description": ""
    },
    {
      "Command": "echo",
      "Target": "üìú Script Path: ${scriptPath}",
      "Value": "blue",
      "Description": ""
    },
    {
      "Command": "storeText",
      "Target": "xpath=//span[contains(@class,'Heading-sub--inline')]",
      "Value": "gps",
      "Description": "Extract GPS coordinates from the page (from detailed location header)"
    },
    {
      "Command": "echo",
      "Target": "GPS Location: ${gps}",
      "Value": "blue",
      "Description": "Display extracted location text"
    },
    {
      "Command": "executeScript",
      "Target": "var t = document.body.innerText; var p = t.includes('Personal Location'); var s = t.includes('Shared location owned by'); if (p && s) { return 'shared'; } if (p && !s) { return 'personal'; } return 'other';",
      "Value": "locationType",
      "Description": "Detect shared vs personal vs other"
    },
    {
      "Command": "echo",
      "Target": "Location type: ${locationType}",
      "Value": "blue",
      "Description": "Show location type"
    },
    {
      "Command": "if_v2",
      "Target": "${locationType} == 'other'",
      "Value": "",
      "Description": ""
    },
    {
      "Command": "echo",
      "Target": "‚ö†Ô∏è Unsupported location type (probably a Hotspot). Skipping.",
      "Value": "red",
      "Description": ""
    },
    {
      "Command": "throwError",
      "Target": "Location type was not personal or shared. Aborting.",
      "Value": "",
      "Description": ""
    },
    {
      "Command": "end",
      "Target": "",
      "Value": "",
      "Description": ""
    },
    {
      "Command": "store",
      "Target": "${gps}",
      "Value": "!clipboard",
      "Description": "Copy extracted location text to clipboard for external use"
    },
    {
      "Command": "executeScript_Sandbox",
      "Target": "var parts = ${gps}.split(','); if (parts.length != 2) return false; var lat = parseFloat(parts[0]); var lon = parseFloat(parts[1]); return (!isNaN(lat) && !isNaN(lon) && lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180);",
      "Value": "isValidGPS",
      "Description": "Validate GPS structure and numeric latitude/longitude bounds"
    },
    {
      "Command": "if_v2",
      "Target": "${isValidGPS} == false",
      "Value": "",
      "Description": "Exit early if GPS values are invalid"
    },
    {
      "Command": "echo",
      "Target": "‚ùå Invalid GPS format in location text.",
      "Value": "red",
      "Description": "Show error for invalid GPS"
    },
    {
      "Command": "throwError",
      "Target": "Stopping due to invalid GPS.",
      "Value": "",
      "Description": "Exit macro if GPS fails validation"
    },
    {
      "Command": "else",
      "Target": "",
      "Value": "",
      "Description": "Valid GPS data was found"
    },
    {
      "Command": "echo",
      "Target": "Valid GPS data found",
      "Value": "blue",
      "Description": "Display confirmation that valid GPS data was found"
    },
    {
      "Command": "end",
      "Target": "",
      "Value": "",
      "Description": "End block for GPS validation"
    },
    {
      "Command": "executeScript_Sandbox",
      "Target": "var coords = ${gps}.split(','); return coords[0].trim();",
      "Value": "lat",
      "Description": "Extract latitude from GPS string"
    },
    {
      "Command": "echo",
      "Target": "Latitude: ${lat}",
      "Value": "blue",
      "Description": "Display parsed lat/lon"
    },
    {
      "Command": "executeScript_Sandbox",
      "Target": "var coords = ${gps}.split(','); return coords[1].trim();",
      "Value": "lon",
      "Description": "Extract longitude from GPS string"
    },
    {
      "Command": "echo",
      "Target": "Longitude: ${lon}",
      "Value": "blue",
      "Description": "Display parsed lat/lon"
    },
    {
      "Command": "XRun",
      "Target": "${pythonPath}",
      "Value": "${scriptPath}",
      "Description": "Run script to format name"
    },
    {
      "Command": "store",
      "Target": "0",
      "Value": "retryCount",
      "Description": ""
    },
    {
      "Command": "label",
      "Target": "waitForFormatted",
      "Value": "",
      "Description": ""
    },
    {
      "Command": "store",
      "Target": "${!clipboard}",
      "Value": "temp",
      "Description": ""
    },
    {
      "Command": "echo",
      "Target": "Clipboard: ${temp}",
      "Value": "blue",
      "Description": ""
    },
    {
      "Command": "executeScript_Sandbox",
      "Target": "var t = '${temp}'.trim(); if (t.indexOf('(') > -1 && t.indexOf(',') > -1) { return true; } else { return false; }",
      "Value": "formattedReady",
      "Description": ""
    },
    {
      "Command": "if_v2",
      "Target": "${formattedReady} == true",
      "Value": "",
      "Description": ""
    },
    {
      "Command": "gotoLabel",
      "Target": "afterFormattedWait",
      "Value": "",
      "Description": ""
    },
    {
      "Command": "end",
      "Target": "",
      "Value": "",
      "Description": ""
    },
    {
      "Command": "executeScript_Sandbox",
      "Target": "return parseInt(${retryCount}) + 1;",
      "Value": "retryCount",
      "Description": ""
    },
    {
      "Command": "echo",
      "Target": "üåÄ Retry loop: ${retryCount}/5",
      "Value": "blue",
      "Description": ""
    },
    {
      "Command": "if_v2",
      "Target": "${retryCount} > 5",
      "Value": "",
      "Description": ""
    },
    {
      "Command": "echo",
      "Target": "‚ùå Timeout waiting for clipboard update",
      "Value": "red",
      "Description": ""
    },
    {
      "Command": "throwError",
      "Target": "Formatted location was never returned. Stopping.",
      "Value": "",
      "Description": ""
    },
    {
      "Command": "end",
      "Target": "",
      "Value": "",
      "Description": ""
    },
    {
      "Command": "pause",
      "Target": "500",
      "Value": "",
      "Description": ""
    },
    {
      "Command": "gotoLabel",
      "Target": "waitForFormatted",
      "Value": "",
      "Description": ""
    },
    {
      "Command": "label",
      "Target": "afterFormattedWait",
      "Value": "",
      "Description": ""
    },
    {
      "Command": "store",
      "Target": "${!clipboard}",
      "Value": "formatted",
      "Description": "Save formatted location"
    },
    {
      "Command": "echo",
      "Target": "Formatted Name: ${formatted}",
      "Value": "blue",
      "Description": "Log formatted result"
    },
    {
      "Command": "executeScript_Sandbox",
      "Target": "var str = '${formatted}'.trim(); return str.indexOf('Unknown') === 0;",
      "Value": "isUnknown",
      "Description": "Check if formatted name begins with 'Unknown'"
    },
    {
      "Command": "if_v2",
      "Target": "${isUnknown} == true",
      "Value": "",
      "Description": "Abort if 'Unknown'"
    },
    {
      "Command": "echo",
      "Target": "‚ö† Location is 'Unknown'. Manual fix needed.",
      "Value": "red",
      "Description": "Warn about unknown"
    },
    {
      "Command": "throwError",
      "Target": "'Unknown' name returned. Stopping.",
      "Value": "",
      "Description": "Stop macro"
    },
    {
      "Command": "end",
      "Target": "",
      "Value": "",
      "Description": "End check"
    },
    {
      "Command": "if_v2",
      "Target": "${locationType} == 'personal'",
      "Value": "",
      "Description": "If it's a personal location"
    },
    {
      "Command": "type",
      "Target": "id=renameLoc",
      "Value": "${formatted}",
      "Description": "Enter new formatted checklist name"
    },
    {
      "Command": "click",
      "Target": "name=renameBut",
      "Value": "",
      "Description": ""
    },
    {
      "Command": "echo",
      "Target": "‚úÖ Personal location renamed",
      "Value": "green",
      "Description": "Log success"
    },
    {
      "Command": "else",
      "Target": "",
      "Value": "",
      "Description": "ELSE shared location"
    },
    {
      "Command": "echo",
      "Target": "Personalising shared checklist location",
      "Value": "blue",
      "Description": "Log formatted result"
    },
    {
      "Command": "clickAndWait",
      "Target": "linkText=My Checklists",
      "Value": "",
      "Description": "Navigate to checklist"
    },
    {
      "Command": "clickAndWait",
      "Target": "xpath=(//li[contains(@class,'ResultsStats--manageMyChecklists')]//a[contains(@href,'/checklist/')])[1]",
      "Value": "",
      "Description": "Open first checklist"
    },
    {
      "Command": "clickAndWait",
      "Target": "xpath=//a[contains(text(),'Edit Location')]",
      "Value": "",
      "Description": "Click Edit"
    },
    {
      "Command": "clickAndWait",
      "Target": "xpath=//a[contains(text(),'Use Latitude/Longitude')]",
      "Value": "",
      "Description": "Choose GPS entry"
    },
    {
      "Command": "type",
      "Target": "name=lat",
      "Value": "${lat}",
      "Description": "Enter lat"
    },
    {
      "Command": "type",
      "Target": "name=lng",
      "Value": "${lon}",
      "Description": "Enter lon"
    },
    {
      "Command": "click",
      "Target": "xpath=//button[@name='continue']",
      "Value": "",
      "Description": "Submit coords"
    },
    {
      "Command": "type",
      "Target": "id=name",
      "Value": "${formatted}",
      "Description": "Input name"
    },
    {
      "Command": "click",
      "Target": "xpath=//button[@name='continue']",
      "Value": "",
      "Description": "Submit name"
    },
    {
      "Command": "echo",
      "Target": "‚úÖ Finished personalising shared checklist location",
      "Value": "green",
      "Description": "Log success"
    },
    {
      "Command": "end",
      "Target": "",
      "Value": "",
      "Description": "Close if block"
    }
  ]
}